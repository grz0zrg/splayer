var sine_lookup_size=8192,sine_lookup_size_m1=sine_lookup_size-1,sine_lookup=new Float32Array(sine_lookup_size),sine_lookup_phase=0,sine_lookup_phase_step=2*Math.PI/sine_lookup_size,s=0,oscillators=[];for(s=0;s<sine_lookup_size;s+=1)sine_lookup[s]=Math.sin(sine_lookup_phase),sine_lookup_phase+=sine_lookup_phase_step;self.onmessage=function(s){"use strict";var e,o,a,i,t=s.data,_=t.sample_rate,n=t.data,p=t.data[0],l=1/(t.options.sps?t.options.sps:60),r=Math.round(l*_),h=n.length*r,u=(n.length*r*2,null),f=null,k=0,d=0,g=0,M=0,c=0,z=0,b=0,m=0,v=1/r,y=0,x=null,F=16.34,w=0,A=0,q=0,b=0;for(o=t.options.octaves?t.height/t.options.octaves:t.height/10,t.options.baseFrequency&&(F=t.options.baseFrequency),A=0;A<t.height;A+=1)a=F*Math.pow(2,A/o),i=a/_*sine_lookup_size,oscillators[t.height-1-A]={phase_step:i,phase_index:Math.random()*sine_lookup_size_m1};for(u=new Float32Array(h),f=new Float32Array(h),m=0;m<h;m+=1){for(k=0,d=0,A=0;A<p.length;A+=1)e=p[A],x=oscillators[e.y],q=sine_lookup[x.phase_index&sine_lookup_size_m1],k+=(e.pl+e.dl*w)*q,d+=(e.pr+e.dr*w)*q,x.phase_index+=x.phase_step;u[m]=k,f[m]=d,g+=Math.abs(k),M+=Math.abs(d),c=Math.max(k,c),z=Math.max(d,z),w+=v,y+=1,y>=r&&(w=0,y=0,b+=1,p=t.data[b])}var I=1-c,P=1-z;for(m=0;m<h;m+=1)u[m]/=I,f[m]/=P;var j=32,B=1/j,C=0;if(h>4*j)for(m=0;m<j;m+=1)u[m]*=C,f[m]*=C,u[h-m-1]*=C,f[h-m-1]*=C,C+=B;g/=h,M/=h,postMessage({uid:t.uid,length:h,data_l:u.buffer,data_r:f.buffer,avg_l:g,avg_r:M},[u.buffer,f.buffer])};